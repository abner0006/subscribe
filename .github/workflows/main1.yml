name: 'Daily Job â˜ main'

# è§¦å‘æœºåˆ¶ï¼šå®šæ—¶æ‰§è¡Œ + æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '30 22 * * *'  # UTC 22:30 â†’ åŒ—äº¬æ—¶é—´ 6:30
    - cron: '30 10 * * *'  # UTC 10:30 â†’ åŒ—äº¬æ—¶é—´ 18:30
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'

# ç¯å¢ƒå˜é‡ï¼šé›†ä¸­ç®¡ç†å…³é”®å‚æ•°
env:
  PYTHON_VERSION: '3.10'        # Python ç‰ˆæœ¬
  RETAIN_DAYS: 7               # å½’æ¡£ä¿ç•™å¤©æ•°ï¼ˆ7å¤©ï¼‰
  HISTORY_DIR: 'history'        # å½’æ¡£ç›®å½•
  # éœ€è¦æ‰“åŒ…çš„æ–‡ä»¶ï¼ˆä¸main1.pyè¾“å‡ºåŒ¹é…ï¼Œæ’é™¤.m3uï¼‰
  FILES_TO_ARCHIVE: >-
    output/full_channels.txt
    output/simple_channels.txt
    output/custom_channels.txt
    output/other_channels.txt
    output/sports.html

jobs:
  run_job:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸å†™å…¥ä»“åº“
      pull-requests: write  # å…è®¸åˆ›å»ºPR

    steps:
      # 1. æ‹‰å–ä»“åº“ä»£ç ï¼ˆæœ€æ–°ç‰ˆactionsï¼‰
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main

      # 2. é…ç½®Pythonç¯å¢ƒï¼ˆæœ€æ–°ç‰ˆactionsï¼‰
      - name: å®‰è£…Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 3. ç¼“å­˜Pythonä¾èµ–ï¼ˆåŠ é€Ÿå®‰è£…ï¼‰
      - name: ç¼“å­˜ä¾èµ–åŒ…
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4. å®‰è£…ä¾èµ–ï¼ˆå¤±è´¥é‡è¯•ï¼‰
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install opencc-python-reimplemented pytz || { 
            echo "ä¾èµ–å®‰è£…å¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡"; 
            pip install opencc-python-reimplemented pytz; 
          }

      # 5. åŒæ­¥è¿œç¨‹ä»£ç å¹¶ç”Ÿæˆæ–‡ä»¶
      - name: åŒæ­¥ä»£ç å¹¶ç”Ÿæˆæ–‡ä»¶
        run: |
          # é…ç½®Gitèº«ä»½
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"

          # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆå¤±è´¥åˆ™ç»ˆæ­¢ï¼‰
          git reset --hard HEAD
          git pull origin main --rebase || { 
            echo "æ‹‰å–ä»£ç å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"; 
            exit 1; 
          }

          # ç”Ÿæˆæ–‡ä»¶ï¼ˆä¸main1.pyåŒ¹é…ï¼Œå¤±è´¥é‡è¯•ä¸€æ¬¡ï¼‰
          python main1.py || { 
            echo "é¦–æ¬¡ç”Ÿæˆæ–‡ä»¶å¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡"; 
            python main1.py || { 
              echo "ç”Ÿæˆæ–‡ä»¶å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"; 
              exit 1; 
            } 
          }

      # 6. æ£€æŸ¥å…³é”®æ–‡ä»¶å®Œæ•´æ€§ï¼ˆä¸main1.pyè¾“å‡ºåŒ¹é…ï¼Œä¿æŒåŸç‰ˆæ£€æŸ¥2ä¸ªæ–‡ä»¶ï¼‰
      - name: æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§
        run: |
          # æ£€æŸ¥main1.pyç”Ÿæˆçš„æ ¸å¿ƒæ–‡ä»¶ï¼ˆä¿æŒåŸç‰ˆ2ä¸ªæ–‡ä»¶çš„æ£€æŸ¥é€»è¾‘ï¼‰
          critical_files=("output/full_channels.txt" "output/custom_channels.txt")
          for file in "${critical_files[@]}"; do
            if [ ! -s "$file" ]; then
              echo "é”™è¯¯ï¼š$file ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œç»ˆæ­¢æäº¤";
              exit 1;
            fi
          done

          # æ£€æŸ¥main1.pyç”Ÿæˆæ–‡ä»¶çš„å…³é”®å†…å®¹ï¼ˆä¸full_channels.txtåŒ¹é…ï¼‰
          if ! grep -q "ğŸŒå¤®è§†é¢‘é“,#genre#" "output/full_channels.txt"; then
            echo "é”™è¯¯ï¼šoutput/full_channels.txt ç¼ºå¤±å…³é”®åˆ†ç±»ï¼Œç»ˆæ­¢æäº¤";
            exit 1;
          fi

      # 7. æ¸…ç†æ—§å½’æ¡£ï¼ˆåªä¿ç•™æœ€è¿‘7å¤©ï¼‰
      - name: æ¸…ç†å†å²å½’æ¡£
        run: |
          mkdir -p ${{ env.HISTORY_DIR }}
          # åˆ é™¤è¶…è¿‡ä¿ç•™å¤©æ•°çš„zipæ–‡ä»¶
          find ${{ env.HISTORY_DIR }} -name "*.zip" -type f -mtime +${{ env.RETAIN_DAYS }} -delete

      # 8. ç”Ÿæˆæ–°å½’æ¡£ï¼ˆä»…æ‰“åŒ…main1.pyè¾“å‡ºçš„é.m3uæ–‡ä»¶ï¼‰
      - name: ç”Ÿæˆä»Šæ—¥å½’æ¡£
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰ä¿®æ”¹ï¼ˆæ— ä¿®æ”¹åˆ™ä¸ç”Ÿæˆæ–°å½’æ¡£ï¼‰
          if git diff --quiet ${{ env.FILES_TO_ARCHIVE }}; then
            echo "æ–‡ä»¶æœªä¿®æ”¹ï¼Œä¸ç”Ÿæˆæ–°å½’æ¡£";
          else
            current_datetime=$(date +"%Y%m%d_%H%M%S")
            zip_filename="${{ env.HISTORY_DIR }}/${current_datetime}_archive.zip"
            # æ‰“åŒ…main1.pyç”Ÿæˆçš„æŒ‡å®šæ–‡ä»¶ï¼ˆæ’é™¤.m3uï¼‰
            zip -j "${zip_filename}" ${{ env.FILES_TO_ARCHIVE }}
            git add "${zip_filename}"
            echo "æ–°å½’æ¡£ç”Ÿæˆï¼š${zip_filename}"
          fi

      # 9. æäº¤æ‰€æœ‰ä¿®æ”¹å¹¶æ¨é€ï¼ˆåŒ…å«main1.pyç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶ï¼‰
      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          # æäº¤main1.pyç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶ï¼ˆTXTå’ŒM3Uï¼‰
          git add output/full_channels.txt output/full_channels.m3u output/simple_channels.txt output/simple_channels.m3u output/custom_channels.txt output/custom_channels.m3u output/other_channels.txt output/sports.html ${{ env.HISTORY_DIR }}/
          git commit -m ":tada: è‡ªåŠ¨æ›´æ–° $(date +'%Y%m%d')" || echo "æ— ä¸»æ–‡ä»¶ä¿®æ”¹éœ€æäº¤"

          # æ¨é€è‡³mainåˆ†æ”¯
          git push origin main || {
            echo "ç›´æ¥æ¨é€å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹å¼";
            # å¤‡ç”¨æ¨é€ï¼ˆå…¼å®¹åˆ†æ”¯ä¿æŠ¤ï¼‰
            temp_branch="auto-update-$(date +'%Y%m%d')"
            git checkout -b $temp_branch
            git push origin $temp_branch
            echo "å·²æ¨é€è‡³ä¸´æ—¶åˆ†æ”¯ï¼š$temp_branchï¼Œè¯·æ‰‹åŠ¨åˆå¹¶è‡³main";
          }

      # 10. ä¸Šä¼ äº§ç‰©ï¼ˆä¸main1.pyè¾“å‡ºå®Œå…¨åŒ¹é…ï¼‰
      - name: ä¿å­˜ç”Ÿæˆçš„æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: generated-files
          path: |
            output/full_channels.txt
            output/full_channels.m3u
            output/simple_channels.txt
            output/simple_channels.m3u
            output/custom_channels.txt
            output/custom_channels.m3u
            output/other_channels.txt
            output/sports.html
            ${{ env.HISTORY_DIR }}/*.zip
    