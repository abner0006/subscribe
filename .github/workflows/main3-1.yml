name: 'main3-1 â˜ output/source/'

# å¹¶å‘é…ç½®ï¼šå…è®¸åŒä¸€åˆ†æ”¯åŒæ—¶è¿è¡Œï¼ˆæœ€å¤š2ä¸ªå®ä¾‹ï¼‰ï¼Œä¸å–æ¶ˆæ­£åœ¨è¿è¡Œçš„å®ä¾‹
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # å…³é”®ï¼šä¸å–æ¶ˆæ­£åœ¨è¿è¡Œçš„å®ä¾‹ï¼Œå…è®¸å¹¶å‘

on:
  schedule:
    - cron: '40 17 * * *'  # UTCæ—¶é—´
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'

env:
  PYTHON_VERSION: '3.10'        
  RETAIN_DAYS: 7               
  HISTORY_DIR: 'history'        
  FILES_TO_ARCHIVE: >-
    output/source/source1.txt
    output/source/source2.txt
    output/source/source3.txt
    output/source/source4.txt
    output/source/sports.html

jobs:
  run_job:
    runs-on: ubuntu-latest
    permissions:
      contents: write  
      pull-requests: write  

    steps:
      # 1. æ‹‰å–ä»“åº“ä»£ç ï¼ˆåŸç‰ˆï¼‰
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main

      # 2. å¼ºåˆ¶åŒæ­¥è¿œç¨‹ä»£ç ï¼ˆåŸç‰ˆï¼‰
      - name: å¼ºåˆ¶åŒæ­¥è¿œç¨‹ä»£ç 
        run: git fetch --prune && git reset --hard origin/main

      # 3. å®‰è£…Pythonï¼ˆåŸç‰ˆï¼‰
      - name: å®‰è£…Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 4. ç¼“å­˜ä¾èµ–åŒ…ï¼ˆåŸç‰ˆï¼‰
      - name: ç¼“å­˜ä¾èµ–åŒ…
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 5. å®‰è£…ä¾èµ–ï¼ˆåŸç‰ˆï¼‰
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install opencc-python-reimplemented pytz || { 
            echo "ä¾èµ–å®‰è£…å¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡"; 
            pip install opencc-python-reimplemented pytz; 
          }

      # 6. åŒæ­¥ä»£ç å¹¶ç”Ÿæˆæ–‡ä»¶ï¼ˆåŸç‰ˆï¼‰
      - name: åŒæ­¥ä»£ç å¹¶ç”Ÿæˆæ–‡ä»¶
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          mkdir -p output/source
          git reset --hard HEAD
          git pull origin main --rebase --autostash || { 
            echo "å˜åŸºå†²çªï¼Œè‡ªåŠ¨ç”¨è¿œç¨‹æœ€æ–°ä»£ç è¦†ç›–æœ¬åœ°";
            git rebase --abort;
            git pull origin main --force;
          }
          python main3.py || { 
            echo "é¦–æ¬¡ç”Ÿæˆå¤±è´¥ï¼Œé‡è¯•"; 
            python main3.py || { exit 1; } 
          }

      # 7. æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§ï¼ˆåŸç‰ˆï¼‰
      - name: æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§
        run: |
          critical_files=("output/source/source1.txt" "output/source/source3.txt")
          for file in "${critical_files[@]}"; do
            if [ ! -s "$file" ]; then
              echo "é”™è¯¯ï¼š$file å¼‚å¸¸ï¼Œç»ˆæ­¢"; exit 1;
            fi
          done
          if ! grep -q "ğŸŒå¤®è§†é¢‘é“,#genre#" "output/source/source3.txt"; then
            echo "é”™è¯¯ï¼šå†…å®¹ç¼ºå¤±ï¼Œç»ˆæ­¢"; exit 1;
          fi

      # 8. æ¸…ç†å†å²å½’æ¡£ï¼ˆåŸç‰ˆï¼‰
      - name: æ¸…ç†å†å²å½’æ¡£
        run: |
          mkdir -p ${{ env.HISTORY_DIR }}
          find ${{ env.HISTORY_DIR }} -name "*.zip" -type f -mtime +${{ env.RETAIN_DAYS }} -delete

      # 9. ç”Ÿæˆä»Šæ—¥å½’æ¡£ï¼ˆåŸç‰ˆï¼‰
      - name: ç”Ÿæˆä»Šæ—¥å½’æ¡£
        run: |
          if git diff --quiet ${{ env.FILES_TO_ARCHIVE }}; then
            echo "æ–‡ä»¶æœªä¿®æ”¹ï¼Œä¸ç”Ÿæˆæ–°å½’æ¡£";
          else
            current_datetime=$(date +"%Y%m%d_%H%M%S")
            zip_filename="${{ env.HISTORY_DIR }}/${current_datetime}_archive.zip"
            zip -j "${zip_filename}" ${{ env.FILES_TO_ARCHIVE }}
            git add "${zip_filename}"
          fi

      # ğŸ”´ æ ¸å¿ƒæ›¿æ¢ï¼šå¹¶å‘å…¼å®¹çš„æš´åŠ›æ¨é€ ğŸ”´
      - name: æäº¤å¹¶æ¨é€æ›´æ”¹ï¼ˆå¹¶å‘å…¼å®¹ï¼Œæš´åŠ›è¦†ç›–ï¼‰
        run: |
          # ä»…æäº¤ç›®æ ‡æ–‡ä»¶ï¼Œé€‚é…å¹¶å‘åœºæ™¯
          git add output/source/ ${{ env.HISTORY_DIR }}/
          # æäº¤å¸¦æ—¶é—´æˆ³ï¼ŒåŒºåˆ†å¹¶å‘å®ä¾‹
          git commit -m ":tada: è‡ªåŠ¨æ›´æ–° $(date +'%Y%m%d_%H%M%S')" || true  
          # å¼ºåˆ¶åŒæ­¥è¿œç¨‹ï¼Œæ¶ˆé™¤å¹¶å‘å†²çª
          git fetch origin main
          git reset --hard origin/main  
          # æš´åŠ›æ¨é€ï¼Œä¼˜å…ˆ --force-with-leaseï¼Œå¤±è´¥åˆ™ --force
          git push origin main --force-with-lease || git push origin main --force

      # 10. ä¿å­˜ç”Ÿæˆçš„æ–‡ä»¶ï¼ˆåŸç‰ˆï¼‰
      - name: ä¿å­˜ç”Ÿæˆçš„æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: generated-files
          path: |
            output/source/source1.txt
            output/source/source1.m3u
            output/source/source2.txt
            output/source/source2.m3u
            output/source/source4.txt
            output/source/sports.html
            output/source/source3.txt
            output/source/source3.m3u
            ${{ env.HISTORY_DIR }}/*.zip
